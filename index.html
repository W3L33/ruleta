<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruleta</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; text-align:center; }
    textarea { width:300px; height:120px; }
    button { padding:10px 20px; font-size:16px; margin-top:10px; cursor:pointer; }
    #winner { height:40px; margin-top:20px; font-size:22px; font-weight:bold; }
    canvas { margin-top:20px; background:#fff; }
  </style>
</head>
<body>

<h1>RULETA</h1>
<p>Pega los nombres</p>
<textarea id="names"></textarea><br>
<button id="spinBtn">Girar</button>

<div id="winner"></div>

<div style="display:flex; justify-content:center; gap:30px; margin-top:20px;">
  <div style="width:200px; text-align:left; background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.15);">
    <h3>üèÜ Ganadores</h3>
    <ol id="winnersList" style="padding-left:20px;"></ol>
  </div>
  <canvas id="wheel" width="400" height="400"></canvas>
</div>

<script>
// =====================
// VARIABLES GLOBALES
// =====================
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const center = canvas.width / 2;

let originalNames = [];
let activeNames = [];
let lastWinnerIndex = null;
let winnersHistory = [];

let angle = 0;
let spinning = false;

// animaci√≥n basada en tiempo
let startTime = null;
const duration = 3500; // ms
let startAngle = 0;
let finalAngle = 0;

// =====================
// RANDOM CRIPTOGR√ÅFICO
// =====================
function secureRandomIndex(max) {
  const array = new Uint32Array(1);
  crypto.getRandomValues(array);
  return array[0] % max;
}

// =====================
// FLECHA
// =====================
function drawArrow() {
  const inside = center * 0.2;
  ctx.save();
  ctx.fillStyle = '#000';
  ctx.shadowColor = '#000';
  ctx.shadowBlur = 6;
  ctx.beginPath();
  ctx.moveTo(center + (center - inside), center);
  ctx.lineTo(canvas.width - 10, center - 15);
  ctx.lineTo(canvas.width - 10, center + 15);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

// =====================
// RULETA BASE
// =====================
function drawBaseWheel() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.beginPath();
  ctx.arc(center, center, center - 10, 0, Math.PI * 2);
  ctx.fillStyle = '#ddd';
  ctx.fill();
  ctx.strokeStyle = '#555';
  ctx.lineWidth = 3;
  ctx.stroke();
  drawArrow();
}

// =====================
// HISTORIAL DE GANADORES
// =====================
function renderWinners() {
  const list = document.getElementById('winnersList');
  list.innerHTML = '';
  winnersHistory.forEach((name, i) => {
    const li = document.createElement('li');
    li.textContent = name;
    list.appendChild(li);
  });
}

// =====================
// RULETA CON NOMBRES
// =====================
function drawWheel() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const slice = (Math.PI * 2) / activeNames.length;

  for (let i = 0; i < activeNames.length; i++) {
    const start = angle + i * slice;
    const end = start + slice;

    ctx.beginPath();
    ctx.moveTo(center, center);
    ctx.arc(center, center, center - 10, start, end);
    ctx.fillStyle = `hsl(${i * 360 / activeNames.length}, 80%, 60%)`;
    ctx.fill();

    ctx.save();
    ctx.translate(center, center);
    ctx.rotate(start + slice / 2);
    ctx.fillStyle = '#fff';
    ctx.font = '16px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(activeNames[i], center - 20, 5);
    ctx.restore();
  }
  drawArrow();
}

// =====================
// ANIMACI√ìN (TIME-BASED)
// =====================
function animate(timestamp) {
  if (!spinning) return;
  if (!startTime) startTime = timestamp;

  const elapsed = timestamp - startTime;
  const progress = Math.min(elapsed / duration, 1);

  // easing suave
  const easeOut = 1 - Math.pow(1 - progress, 3);
  angle = startAngle + easeOut * (finalAngle - startAngle);

  drawWheel();

  if (progress < 1) {
    requestAnimationFrame(animate);
  } else {
    spinning = false;
    startTime = null;
    const winnerName = activeNames[lastWinnerIndex];
    document.getElementById('winner').textContent = `Ganador: ${winnerName}`;

    // Guardar historial
    winnersHistory.push(winnerName);
    renderWinners();
  }
}

// =====================
// BOT√ìN
// =====================
document.getElementById('spinBtn').addEventListener('click', () => {
  if (spinning) return;

  const text = document.getElementById('names').value.trim();

  // üîÑ reinicio total
  if (text === '') {
    originalNames = [];
    activeNames = [];
    lastWinnerIndex = null;
    winnersHistory = [];
    document.getElementById('winner').textContent = '';
    renderWinners();
    drawBaseWheel();
    return;
  }

  // primer giro
  if (activeNames.length === 0) {
    originalNames = text.split('\n').map(n => n.trim()).filter(n => n);
    activeNames = [...originalNames];
  }

  // eliminar ganador anterior
  if (lastWinnerIndex !== null) {
    activeNames.splice(lastWinnerIndex, 1);
    lastWinnerIndex = null;
  }

  if (activeNames.length < 2) {
    alert('Se necesitan al menos dos nombres');
    drawBaseWheel();
    return;
  }

  // üé∞ ELECCI√ìN CASINO (con variaci√≥n intra‚Äësegmento)
  const slice = (Math.PI * 2) / activeNames.length;
  lastWinnerIndex = secureRandomIndex(activeNames.length);

  // offset aleatorio DENTRO del segmento (no siempre al centro)
  const offsetArray = new Uint32Array(1);
  crypto.getRandomValues(offsetArray);
  const intraOffset = (offsetArray[0] / 0xffffffff - 0.5) * slice * 0.8;

  const targetAngle =
    (Math.PI * 2) - (lastWinnerIndex * slice + slice / 2 + intraOffset);

  const extraSpins = 5 * Math.PI * 2;

  startAngle = angle % (Math.PI * 2);
  finalAngle = targetAngle + extraSpins;

  document.getElementById('winner').textContent = '';
  spinning = true;
  requestAnimationFrame(animate);
});

// =====================
// VISIBILIDAD (PRO)
// =====================
document.addEventListener('visibilitychange', () => {
  if (document.hidden && spinning) {
    spinning = false;
    startTime = null;
  }
});

// =====================
// INICIO
// =====================
drawBaseWheel();
</script>

</body>
  <footer style="margin-top:30px; font-size:14px; color:#555;">
  By 
  <a href="https://w3l33.github.io/" 
     style="color:#0077cc; text-decoration:none; font-weight:bold;">
     WeLee
  </a>
</footer>
</html>



